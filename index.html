
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰è‰ä¸çš„å¾®ç¬‘ - è™šæ‹Ÿå¥³å‹æ¨¡æ‹Ÿ</title>
    <style>
        :root {
            --bg-color: #dcdcdc;
            --text-color: #2c3e50;
            --accent-color: #1a1a1a;
            --ui-bg: rgba(255, 255, 255, 0.95);
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'PingFang SC', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            transition: background-color 2s ease;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            background: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(0,0,0,0.05) 100%);
        }

        #character-sprite {
            position: absolute;
            bottom: 15%;
            width: 100%;
            height: 80%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom center;
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1;
            background-color: rgba(0,0,0,0.03);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #img-error-hint {
            position: absolute;
            bottom: 50%;
            text-align: center;
            font-size: 14px;
            color: #888;
            pointer-events: none;
            display: none;
        }

        #flash-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 10;
            transition: opacity 0.4s ease;
        }

        #ui-box {
            position: relative;
            width: 85%;
            background: var(--ui-bg);
            padding: 25px;
            margin-bottom: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            z-index: 5;
            border: 1px solid rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
        }

        #name-tag {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 12px;
            color: #000;
            letter-spacing: 1px;
            border-left: 5px solid var(--accent-color);
            padding-left: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #voice-indicator {
            font-size: 12px;
            color: #6e8efb;
            font-weight: normal;
            display: none;
        }

        #dialogue-text {
            height: 60px;
            font-size: 1.1em;
            line-height: 1.6;
            color: #333;
        }

        #options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .option-btn {
            background: var(--accent-color);
            color: #fff;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            text-align: left;
        }

        .option-btn:hover {
            background: #444;
            transform: translateY(-2px);
        }

        .gemini-btn {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            margin-top: 10px;
            text-align: center;
        }

        #stats {
            position: absolute;
            top: 30px; left: 30px; z-index: 5;
            background: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border-radius: 15px;
        }

        .stat-bar {
            width: 200px; height: 8px;
            background: #eee; border-radius: 4px; overflow: hidden;
        }

        #happiness-fill {
            width: 0%; height: 100%;
            background: linear-gradient(90deg, #666, #333);
            transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        #music-control {
            position: absolute;
            top: 30px; right: 30px; z-index: 10;
            background: white;
            border: none;
            width: 40px; height: 40px;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }

        #ai-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 100;
            justify-content: center; align-items: center;
        }

        #ai-modal-content {
            background: white; width: 80%; max-width: 500px;
            padding: 30px; border-radius: 20px; text-align: center;
        }

        body.transformed { background-color: #fdfdfd; }
        body.transformed #happiness-fill { background: linear-gradient(90deg, #ff9a9e, #fad0c4); }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shaking { animation: shake 0.2s ease-in-out infinite; }
        #loading-indicator { display: none; font-size: 12px; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="flash-overlay"></div>
    <audio id="bg-music" loop>
        <source src="bgm.mp3" type="audio/mpeg">
    </audio>
    <button id="music-control">ğŸ”‡</button>

    <div id="game-container">
        <div id="stats">
            <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">è‰è‰ä¸çš„å¿ƒé˜²</div>
            <div class="stat-bar"><div id="happiness-fill"></div></div>
            <div id="loading-indicator">âœ¨ è‰è‰ä¸æ­£åœ¨å“åº”...</div>
        </div>

        <div id="character-sprite">
            <div id="img-error-hint">å›¾ç‰‡ç¼ºå¤±<br><small>æ£€æŸ¥æœ¬åœ°æ–‡ä»¶åæ˜¯å¦åŒ¹é…</small></div>
        </div>

        <div id="ui-box">
            <div id="name-tag">
                <span>è‰è‰ä¸</span>
                <span id="voice-indicator">ğŸ”Š æ­£åœ¨è¯´è¯...</span>
            </div>
            <div id="dialogue-text">...</div>
            <div id="options-container"></div>
            <button id="gemini-thought-btn" class="option-btn gemini-btn">âœ¨ æ´å¯Ÿå†…å¿ƒ (é…éŸ³ç‰ˆ)</button>
        </div>
    </div>

    <div id="ai-modal">
        <div id="ai-modal-content">
            <div id="ai-title" style="font-weight: bold; margin-bottom: 15px; font-size: 1.2em;">è‰è‰ä¸çš„å†…å¿ƒç‹¬ç™½</div>
            <div id="ai-text" style="font-style: italic; line-height: 1.8; color: #444; margin-bottom: 20px;">...</div>
            <button id="close-modal" style="background: #333; color: white; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer;">è¿”å›</button>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const character = {
            name: "è‰è‰ä¸",
            happiness: 0,
            isTransformed: false,
            sprites: {
                cold: "image_be5d64.jpg",       
                shy: "image_c84ace.jpg",        
                transformed: "image_c83f68.jpg" 
            }
        };

        const bgMusic = document.getElementById('bg-music');
        const musicBtn = document.getElementById('music-control');
        const dialogueEl = document.getElementById('dialogue-text');
        const spriteEl = document.getElementById('character-sprite');
        const fillEl = document.getElementById('happiness-fill');
        const optionsEl = document.getElementById('options-container');
        const flashEl = document.getElementById('flash-overlay');
        const thoughtBtn = document.getElementById('gemini-thought-btn');
        const aiModal = document.getElementById('ai-modal');
        const aiText = document.getElementById('ai-text');
        const voiceIndicator = document.getElementById('voice-indicator');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorHint = document.getElementById('img-error-hint');

        let isMusicPlaying = false;

        // --- PCM to WAV è½¬æ¢ (TTSä½¿ç”¨) ---
        function pcmToWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(0, 'RIFF');
            view.setUint32(4, 32 + pcmData.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcmData.length * 2, true);
            for (let i = 0; i < pcmData.length; i++) view.setInt16(44 + i * 2, pcmData[i], true);
            return new Blob([buffer], { type: 'audio/wav' });
        }

        // --- è¯­éŸ³åˆæˆ ---
        async function speak(text) {
            if (!apiKey) return;
            voiceIndicator.style.display = "inline";
            let emotion = "å†·æ·¡åœ°";
            if (character.isTransformed) emotion = "æ¸©æŸ”å¹¸ç¦åœ°";
            else if (character.happiness >= 50) emotion = "ç•¥æ˜¾å®³ç¾åœ°";

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: `ç”¨${emotion}è¯­æ°”è¯´ï¼š${text}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                }
            };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                const audioBase64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (audioBase64) {
                    const binaryString = atob(audioBase64);
                    const pcmData = new Int16Array(binaryString.length / 2);
                    for (let i = 0; i < pcmData.length; i++) {
                        pcmData[i] = binaryString.charCodeAt(i * 2) | (binaryString.charCodeAt(i * 2 + 1) << 8);
                    }
                    const wavBlob = pcmToWav(pcmData, 24000);
                    const audio = new Audio(URL.createObjectURL(wavBlob));
                    audio.onended = () => voiceIndicator.style.display = "none";
                    audio.play();
                }
            } catch (e) { voiceIndicator.style.display = "none"; }
        }

        // --- éŸ³ä¹æ§åˆ¶ ---
        function toggleMusic() {
            if (isMusicPlaying) {
                bgMusic.pause();
                musicBtn.innerText = "ğŸ”‡";
            } else {
                bgMusic.play().catch(e => {});
                musicBtn.innerText = "ğŸ”Š";
            }
            isMusicPlaying = !isMusicPlaying;
        }
        musicBtn.onclick = toggleMusic;

        // --- æ¸¸æˆé€»è¾‘ ---
        const scenes = [
            {
                text: "è‰è‰ä¸æœºæ¢°åœ°ç»´æŒç€å¥¹çš„è¥ä¸šå§¿åŠ¿ã€‚å¦‚æœä½ ä¸èƒ½æ‰“åŠ¨å¥¹ï¼Œå¥¹å¯èƒ½æ°¸è¿œåªæ˜¯ä¸€ä¸ªâ€œå¥³ä»†åŸå‹â€ã€‚",
                options: [
                    { text: "â€œè¿™ä¸ªæ‰‹åŠ¿ï¼Œæ˜¯å› ä¸ºå¿ƒæƒ…å¥½å—ï¼Ÿâ€", score: 10, reply: "è¿™æ˜¯åˆ¶å¼åŒ–çš„åŠ¨ä½œã€‚æˆ‘çš„å¿ƒæƒ…å¹¶ä¸åŒ…å«åœ¨æœåŠ¡å†…å®¹å†…ã€‚" },
                    { text: "é€å¥¹ä¸€ä¸ªå°å·§çš„é½¿è½®æŒ‚é¥°", score: 35, reply: "â€¦â€¦å¾ˆç²¾å¯†çš„æ„é€ ã€‚è°¢è°¢ã€‚" },
                    { text: "â€œå…¶å®ï¼Œä½ ä¸éœ€è¦å‹‰å¼ºè‡ªå·±æ‘†å‡ºè¿™ç§å§¿åŠ¿ã€‚â€", score: 20, reply: "èŒä¸šé“å¾·ã€‚â€¦â€¦è™½ç„¶ç»´æŒä¹…äº†ç¡®å®æœ‰ç‚¹ç´¯ã€‚" }
                ]
            },
            {
                text: "å¥¹æ‘†å¼„ç€é‚£ä¸ªé½¿è½®ï¼Œçœ¼ç¥ä¸åƒåˆšæ‰é‚£ä¹ˆé”åˆ©äº†ã€‚ä¼¼ä¹æœ‰ä¸€ä¸åä¸ºâ€œæƒ…æ„Ÿâ€çš„ä¸œè¥¿åœ¨æµåŠ¨ã€‚",
                options: [
                    { text: "â€œç¬‘ä¸€ä¸ªå§ï¼Œä½ ç¬‘èµ·æ¥ä¸€å®šå¾ˆå¥½çœ‹ã€‚â€", score: 25, reply: "â€¦â€¦è¿™ç§æ²¡æ ¹æ®çš„èµç¾ï¼Œåªä¼šè®©æˆ‘è§‰å¾—å›°æ‰°ã€‚" },
                    { text: "â€œå·¥ä½œç»“æŸåï¼Œæƒ³å»çœ‹çœ‹çœŸæ­£çš„æœºæ¢°å±•å—ï¼Ÿâ€", score: 40, reply: "ï¼â€¦â€¦å¦‚æœæ˜¯ä½ çš„é‚€è¯·ï¼Œæˆ‘å¯ä»¥è€ƒè™‘ã€‚" },
                    { text: "â€œä½ çœ‹èµ·æ¥æ¯”åˆšæ‰æ¸©æŸ”å¤šäº†ã€‚â€", score: 15, reply: "é‚£æ˜¯ä½ çš„é”™è§‰ã€‚æˆ‘åªæ˜¯åœ¨èŠ‚çœé¢éƒ¨è‚Œè‚‰çš„ä½“åŠ›ã€‚" }
                ]
            }
        ];

        let currentSceneIndex = 0;

        async function callGemini(prompt, systemPrompt = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "å¥¹åœ¨æ²‰æ€...";
            } catch (e) { return "ï¼ˆè¿æ¥è¶…æ—¶...ï¼‰"; }
        }

        thoughtBtn.onclick = async () => {
            loadingIndicator.style.display = "block";
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªäºŒæ¬¡å…ƒä½œå®¶ã€‚è§’è‰²æ˜¯è‰è‰ä¸ï¼Œå†·æ¼ å¥³ä»†ã€‚å½“å‰å¥½æ„Ÿåº¦ ${character.happiness}/100ã€‚`;
            const result = await callGemini("å†™ä¸€æ®µå¥¹çš„å†…å¿ƒç‹¬ç™½", systemPrompt);
            aiText.innerText = result;
            aiModal.style.display = "flex";
            loadingIndicator.style.display = "none";
            speak(result);
        };

        function updateUI() {
            fillEl.style.width = `${Math.min(character.happiness, 100)}%`;
            let currentImg = character.isTransformed ? character.sprites.transformed : (character.happiness >= 60 ? character.sprites.shy : character.sprites.cold);
            
            const tempImg = new Image();
            tempImg.src = currentImg;
            tempImg.onload = () => {
                spriteEl.style.backgroundImage = `url('${currentImg}')`;
                errorHint.style.display = "none";
            };
            tempImg.onerror = () => {
                spriteEl.style.backgroundImage = "none";
                errorHint.style.display = "block";
            };

            if (character.happiness >= 100 && !character.isTransformed) triggerTransformation();
        }

        function triggerTransformation() {
            character.isTransformed = true;
            flashEl.style.opacity = "1";
            document.body.classList.add('transformed');
            bgMusic.volume = 0.6; // å˜èº«åéŸ³ä¹åŠ å¼º
            setTimeout(() => {
                flashEl.style.opacity = "0";
                updateUI();
                const reply = "è¿™ç§æ„Ÿè§‰â€¦â€¦å¾ˆå¥‡æ€ªã€‚è°¢è°¢ä½ ï¼Œè®©æˆ‘æˆä¸ºäº†â€˜æˆ‘â€™ã€‚";
                dialogueEl.innerText = "â€œ" + reply + "â€";
                speak(reply);
                optionsEl.innerHTML = '<button class="option-btn" onclick="location.reload()">é‡æ–°å¼€å§‹</button>';
            }, 600);
        }

        function handleOption(score, reply) {
            if (!isMusicPlaying) { // é¦–æ¬¡ç‚¹å‡»æ—¶å¼€å¯éŸ³ä¹
                bgMusic.play().then(() => { isMusicPlaying = true; musicBtn.innerText = "ğŸ”Š"; bgMusic.volume = 0.3; });
            }
            character.happiness += score;
            dialogueEl.innerText = "â€œ" + reply + "â€";
            optionsEl.innerHTML = "";
            spriteEl.classList.add('shaking');
            setTimeout(() => spriteEl.classList.remove('shaking'), 300);
            updateUI();
            speak(reply);
            if (!character.isTransformed) {
                setTimeout(() => {
                    currentSceneIndex = (currentSceneIndex + 1) % scenes.length;
                    renderScene();
                }, 2500);
            }
        }

        function renderScene() {
            const scene = scenes[currentSceneIndex];
            dialogueEl.innerText = scene.text;
            optionsEl.innerHTML = "";
            scene.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt.text;
                btn.onclick = () => handleOption(opt.score, opt.reply);
                optionsEl.appendChild(btn);
            });
        }

        document.getElementById('close-modal').onclick = () => aiModal.style.display = "none";
        window.onload = () => { updateUI(); renderScene(); };
    </script>
</body>
</html>